<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Chat</title>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script type="text/javascript" src="js/sha256.js"></script>
    <script type="text/javascript" src="js/jstorage.js"></script>
    <script type="text/javascript" src="js/mustache.js"></script>
    <script type="text/javascript" src="js/utils_common.js"></script>
    <script type="text/javascript" src="js/pointrel_authentication.js"></script>
    <script type="text/javascript" src="js/pointrel20130202ForJQuery.js"></script>
</head>
<body>
<b>Chat program</b> <a href="login.html">login/logout page</a>  <span id="form_loginStatus">Not logged in</span><br/>
<!--suppress HtmlFormInputWithoutLabel -->

<input type="text" id="message_to_send" size="63"/>
<input type="button" id="button_send" onClick="send();" value="Send"/>
<input type="button" id="button_history" onClick="history();" value="History"/>
<input type="button" id="button_forwards" onClick="forward();" value="Forward"/>
<input type="button" id="button_refresh" onClick="refresh();" value="Refresh"/>
<!-- <input type="button" id="button_forwards" onClick="addTestData();" value="Add Test Data" /> -->

<div id="div_messages">Welcome (messages go here)</div>

<script type="text/javascript">
    $($.pointrel_authentication.loginPageLoaded);
    $(setupTimer);

    function setupTimer() {
        window.setInterval(refresh, 5000);
    }

    // A single use class to do a recursive search for versions in a linked list
    // Recursively go through a linked list of versions, up to but not including the stopAtVersionURI
    // stopAtVersionURI can be empty or null to load all versions
    // the search depth can be limited by specifying a maximumSearchDepth as a positive integer, otherwise use null
    // has a endingStatus of "end" if reached the end, "more" if there are more not searched due to maximum search limits,
    // "match" if stopped because reach matching URI, or "error" if something went wrong
    function PointrelVersionFollower(startingVersionURI, stopAtVersionURI, maximumSearchDepth, callbackForAllVersions, callbackForNextVersion) {
        this.startingVersionURI = startingVersionURI;
        this.stopAtVersionURI = stopAtVersionURI;
        this.maximumSearchDepth = maximumSearchDepth;
        this.callbackForAllVersions = callbackForAllVersions;
        this.callbackForNextVersion = callbackForNextVersion;
        // reachedEnd can be "end", "more", "match", or "error"
        this.versions = [];
        this.searchStarted = false;
        this.endingStatus = null;
        this.errorStatus = null;
        // Maybe add filtering and then counting versions read
        // Maybe make a variant that can follow multiple diverging and converging branches

        this.done = function (status) {
            this.endingStatus = status;
            console.log("endingStatus", this.endingStatus);
            if (typeof(this.callbackForAllVersions) == "function") this.callbackForAllVersions(null, this.versions, this.endingStatus, this);
        };

        this.nextVersion = function (version) {
            if (typeof(this.callbackForNextVersion) == "function") this.callbackForNextVersion(null, version, this);
        };

        this.doneBecauseOfError = function (error) {
            this.endingStatus = "error";
            this.errorStatus = error;
            console.log("endingStatus", this.endingStatus);
            console.log("errorStatus", this.errorStatus);
            if (typeof(this.callbackForAllVersions) == "function") this.callbackForAllVersions(this.errorStatus, this.versions, this.endingStatus, this);
        };

        this.getPreviousVersionsRecursively = function (versionURI, currentSearchDepth) {
            console.log("getPreviousVersionsRecursively", versionURI, currentSearchDepth);
            if (!versionURI) {
                this.done("end");
            } else if (versionURI === this.stopAtVersionURI) {
                this.done("match");
            } else if (this.maximumSearchDepth && currentSearchDepth >= this.maximumSearchDepth) {
                this.done("more");
            } else {
                // JavaScript has "this" refer to the object a function is called on, or the global object
                var self = this;
                pointrel_resource_get(versionURI, function (error, versionContents) {
                    console.log("callback from pointrel_resource_get", versionURI);
                    if (error) {
                        var message = "Error happened on versionContents get";
                        alert(message);
                        self.doneBecauseOfError(message);
                        return;
                    }
                    console.log("versionContents:", versionContents);
                    var version = JSON.parse(versionContents);
                    console.log("version read", version);
                    // Make a note of the place the version was read from in the version itself
                    version._readFromVersionURI = versionURI;
                    self.versions.push(version);
                    var previousVersion = version.previousVersion;
                    self.nextVersion(version);
                    self.getPreviousVersionsRecursively(previousVersion, currentSearchDepth + 1);
                });
            }
        };

        this.search = function () {
            if (this.searchStarted) throw "Search can only be called once";
            this.searchStarted = true;
            this.getPreviousVersionsRecursively(this.startingVersionURI, 0);
        };
    }

    function PointrelVariable(variableName) {
        this.variableName = variableName;
        this.latestVariableVersionURI = null;
        this.mostRecentlyLoadedVersionURI = null;
        this.callbackWhenVersionsLoaded = null;

        // TODO: Handle issue of searching with previous version not latest version -- semantic issue to resolve on meaning of those

//        this.getLatestVersionX = function(callback) {
//            var self = this;
//            pointrel_variable_get(this.variableName, function (error, variableGetResult) {
//                console.log("pointrel_variable_get");
//                if (error) {
//                    alert("Error happened on variable get");
//                    self.latestVersionURI = null;
//                    self.latestVersion = null;
//                    callback(error, null);
//                    return;
//                }
//                self.latestVersionURI = variableGetResult.currentValue;
//                pointrel_resource_get(self.latestVersionURI, function (error, versionContents) {
//                    console.log("pointrel_resource_get");
//                    if (error) {
//                        alert("Error happened on versionContents get");
//                        self.latestVersionURI = null;
//                        self.latestVersion = null;
//                        callback(error, null);
//                        return;
//                    }
//                    console.log("versionContents:", versionContents);
//                    var version  = JSON.parse(versionContents);
//                    // Make a note of the place the version was read from in the version itself
//                    version._readFromVersionURI = self.latestVersionURI;
//                    self.latestVersion = version;
//                    callback(null, self.latestVersion);
//                });
//            });
//        };

        this.getLatestVariableVersionURI = function(callback) {
            console.log("getLatestVariableVersionURI -- callback", callback);
            var self = this;
            pointrel_variable_get(this.variableName, function (error, variableGetResult) {
                console.log("callback for pointrel_variable_get in getLatestVariableVersionURI");
                if (error) {
                    alert("Error happened on variable get");
                    // self.latestVariableVersionURI = null;
                    if (typeof(callback) == "function") callback(error, null);
                    return;
                }
                self.latestVariableVersionURI = variableGetResult.currentValue;
                console.log("getLatestVariableVersionURI result", self.latestVariableVersionURI);
                console.log("Callback", callback);
                if (typeof(callback) == "function") callback(null, self.latestVariableVersionURI);
             });
        };

        this.newVersionsDone = function (error, versions, endingStatus, follower) {
            console.log("newVersionsDone in variable", error, endingStatus, versions);
            console.log("newVersionsDone this", this);
            if (error) {
                alert("error");
                if (typeof(this.callbackWhenVersionsLoaded) == "function") this.callbackWhenVersionsLoaded(error, versions, endingStatus, follower);
                return;
            }
            if (versions) {
                this.mostRecentlyLoadedVersionURI = this.latestVariableVersionURI;
            }
            console.log("about to try callback", this.callbackWhenVersionsLoaded);
            if (typeof(this.callbackWhenVersionsLoaded) == "function") this.callbackWhenVersionsLoaded(error, versions, endingStatus, follower);
            console.log("after tried callback");
        };

        this.getNewVersions = function (callbackWhenVersionsLoaded) {
            console.log("getNewVersions -- ", callbackWhenVersionsLoaded);
            this.callbackWhenVersionsLoaded = callbackWhenVersionsLoaded;
            console.log("after set: ", this.callbackWhenVersionsLoaded);
            var self = this;
            this.getLatestVariableVersionURI(function (error, variableGetResult) {
                console.log("callback in getNewVersions after getLatestVariableVersionURI");
                if (error) {
                    alert("error getting latest value of variable");
                    // TODO: No callback for this situation?
                    return;
                }
                self.follower = new PointrelVersionFollower(self.latestVariableVersionURI, self.mostRecentlyLoadedVersionURI, 100, self.newVersionsDone.bind(self), null);
                console.log("about to do follower.search");
                self.follower.search();
            });
        };

        this.setNewVersionURI = function (newVersionURI, callback) {
            var self = this;
            pointrel_variable_set(this.variableName, this.latestVariableVersionURI, newVersionURI, function (error, status) {
                if (error) {
                    alert("Error happened when trying to set variable: " + JSON.stringify(status));
                    return;
                }
                console.log("after updating to: ", newVersionURI);
                self.latestVariableVersionURI = newVersionURI;
                if (typeof(callback) == "function") callback(error, status, newVersionURI);
            });
        };
    }

    var variable = new PointrelVariable("chat-test-001");
    var messages = [];
    var lastHistory = 0;

    function newVersionsDone2(error, versions, endingStatus, follower) {
        console.log("newVersionsDone: ", endingStatus, error, versions);
        if (error) { alert("error"); return; }
        if (versions) {
            var versionsReversed = versions.slice(0).reverse();
            for (var i in versionsReversed) {
                //noinspection JSUnfilteredForInLoop
                var version = versionsReversed[i];
                // messages.push(version.timestamp + " " + version.message);
                messages.push(version);
            }
            updateMessagesList();
        }
    }

    function refresh() {
        variable.getNewVersions(newVersionsDone2);
    }

    function store(message) {
        console.log("store message", message);
        // Do a refresh or something first to make sure the variable is as up-to-date as possible
        variable.getLatestVariableVersionURI(function (error, latestVariableVersionURI) {
            console.log("in callback after tried to get latest variable");
            // TODO: Better handling for creating a variable
            if (error) { alert("Error updating variable -- ignoring in case it is new"); }
            var timestamp = new Date().toISOString();
            var userID = $.pointrel_authentication.getUserIDOrAnonymous();
            var version = {timestamp: timestamp, userID: userID, previousVersion: latestVariableVersionURI, message: message};
            console.log("version:", version);
            var versionAsString = JSON.stringify(version);
            console.log("versionAsString:", versionAsString);
            var newVersionURI = pointrel_resource_add(encodeAsUTF8(versionAsString), "Version.json", function(error, status) {
                if (error) { alert("could not write new version: " + JSON.stringify(status)); return }
                console.log("wrote newVersionURI:", newVersionURI);
                console.log("about to update variable");
                variable.setNewVersionURI(newVersionURI, function() {
                    if (error) {
                        alert("error updating variable");
                        return;
                    }
                    refresh();
                });
            });
        });
    }

    function updateMessagesList() {
        // Put all the messages int to the component that displays them
        var output = "";
        var messagesReversed = messages.slice(0);
        messagesReversed.reverse();
        for (var i in messagesReversed) {
            //noinspection JSUnfilteredForInLoop
            var oldMessage = messagesReversed[i];
            output = output + displayStringForTimestamp(oldMessage.timestamp) + " " + oldMessage.userID + " " + oldMessage.message + "<br/>";
        }
        $("#div_messages").html(output);
    }

    function send() {
        const $message_to_send = $("#message_to_send");
        var message = $message_to_send.val();
        console.log("send pressed", message);
        $message_to_send.val("");
        //messages.push(message);
        //console.log(messages);
        lastHistory = messages.length;
        console.log("lastHistory", lastHistory);
        // updateMessagesList();
        // TODO: This position may be off depending on what others are doing with the list...
        lastHistory = messages.length + 1;
        store(message);
    }

    function history() {
        console.log("history pressed");
        console.log("lastHistory before history", lastHistory);
        // var pastElement = messages.slice(-1)[0];
        lastHistory = lastHistory - 1;
        if (lastHistory < 0) {
            lastHistory = 0;
            alert("at bottom of history");
        }
        var pastElement = messages[lastHistory];
        console.log(pastElement);
        $("#message_to_send").val(pastElement.message);
        console.log("lastHistory after history", lastHistory);
    }

    function forward() {
        console.log("forward pressed");
        console.log("lastHistory before forward", lastHistory);
        lastHistory = lastHistory + 1;
        if (lastHistory > messages.length - 1) {
            lastHistory = messages.length - 1;
            alert("at top of history");
        }
        var pastElement = messages[lastHistory];
        console.log("pastElement to put in message", pastElement);
        $("#message_to_send").val(pastElement.message);
        pastElement = messages[lastHistory];
        console.log("pastElement at new position", pastElement);
        console.log("lastHistory after forward", lastHistory);
    }

    //   function addTestData() {
    //      messages = ["a", "b", "c"];
    //      lastHistory = 3;
    //      console.log("test data loaded messages:", messages, "lastHistory:" , lastHistory);
    //   }

    // jQuery Document
    $(document).ready(function () {
        console.log("Hello");

        // Send message if enter is pressed in that input field
        $("#message_to_send").keyup(function(event){
            if(event.keyCode == 13) {
                $("#button_send").click();
            }
        });
    });
</script>
</body>
</html>