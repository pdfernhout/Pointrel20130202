<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset='utf-8'>
    <title>Pointrel In JavaScript viewer</title>
    <script type="text/javascript" src="../jquery-1.9.1.js"></script>
    <script type="text/javascript" src="javascript-libs/sha256.js"></script>
    <script type="text/javascript" src="javascript-libs/jstorage.js"></script>
    <script type="text/javascript" src="javascript-libs/pointrel_authentication.js"></script>
    <script type="text/javascript" src="javascript-libs/pointrel20130202ForJQuery.js"></script>
    <script type="text/javascript" src="javascript-libs/markdown.js"></script>
    <script type="text/javascript">
        var currentVersionURI = "";
        var variableName = "editor-test";

        // TODO: Have some way of passing in the userID, timestamp, and document separately for a resource

        function getParameter(paramName) {
            var searchString = window.location.search.substring(1);
            var i;
            var val;
            var params = searchString.split("&");

            for (i = 0; i < params.length; i++) {
                val = params[i].split("=");
                if (val[0] == paramName) {
                    return decodeURI(val[1]);
                }
            }
            return null;
        }

        function loadLatestFromParameter() {
            var chosenVariable = getParameter("documentName");
            if (chosenVariable) {
                console.log("Read document from: " + chosenVariable);
                variableName = chosenVariable;
                latest();
                var url = document.URL;
                // var tempArray = url.split("?");
                // var baseURL = tempArray[0];
                var baseURL = "viewer.html";
                baseURL = baseURL.replace("viewer.html", "editor.html");
                var newURI = baseURL + "?documentName=" + encodeURI(variableName);
                console.log("Updating editor link URI to:", newURI);
                $("a#editLink").prop("href", newURI);
                newURI = newURI.replace("editor.html", "versions.html");
                console.log("Updating versionsLink URI to:", newURI);
                $("a#versionsLink").prop("href", newURI);
            }
        }

        $(document).ready(loadLatestFromParameter);

        function process(text) {
            // Seems like jQuery is handling this anyway?
            // return $('<div/>').text(text).html();
            // text = text.replace(/\n/g, '<br />');
            text = markdown.toHTML(text);
            console.log("about to convert using marked");
            // text = marked(text);
            // text = text.replace(new RegExp("[A-Z]([A-Z0-9]*[a-z][a-z0-9]*[A-Z]|[a-z0-9]*[A-Z][A-Z0-9]*[a-z])[A-Za-z0-9]*", "g"), function (match) {
            //  return '<a href="viewer.html?documentName=' + match + '">' + match + '</a>';
            //});
            return text;
        }

        function startsWith(data, start) {
            return data.substring(0, start.length) === start;
        }

        function latest() {
            $("#documentName").text(variableName);
            // Special handling if it is a resource instead of a variable
            if (startsWith(variableName, "pointrel://")) {
                $("#timestamp").text("???");
                $("#userID").text("???");
                $("#refreshAndEdit").hide();
                loadResource(variableName);
                return
            }
            //noinspection JSJQueryEfficiency
            $("#refreshAndEdit").show();
            pointrel_variable_get(variableName, function (error, variableGetResult) {
                console.log("pointrel_variable_get");
                if (error) {
                    currentVersionURI = "";
                    $("#timestamp").text("unknown");
                    $("#userID").text("unknown");
                    // $("#documentContent").text("");
                    $("#documentContent").text("Could not retrieve document -- maybe you need to create it?");
                    // alert("Error happened on variable get; variable name may be new? Result: " + variableGetResult.message);
                    return;
                }
                var versionURI = variableGetResult.currentValue;
                loadVersion(versionURI);
            });
        }

        function loadVersion(versionURI) {
            pointrel_resource_get(versionURI, function (error, versionContents) {
                console.log("pointrel_resource_get");
                if (error) {
                    alert("Error happened on versionContents get");
                    return;
                }
                console.log("versionContents:", versionContents);
                var version = JSON.parse(versionContents);
                var textURI = version.value;
                $("#timestamp").text(version.timestamp);
                $("#userID").text(version.userID);
                currentVersionURI = versionURI;
                loadResource(textURI);
            });
        }

        function loadResource(textURI) {
            pointrel_resource_get(textURI, function (error, text) {
                console.log("pointrel_resource_get2 ");
                if (error) {
                    alert("Error happened when getting text of version");
                    $("#documentContent").html("<b>Problem getting text for: " + textURI + "</b>");
                    return;
                }
                //noinspection JSJQueryEfficiency
                $("#documentContent").html(process(text));
            });
        }
    </script>
</head>
<body>
Document: <b id="documentName">documentName</b> Time: <b id="timestamp">Timestamp</b> User: <b id="userID">userID</b><br/>
<div id="refreshAndEdit">
<input type="button" onclick="latest()" value="Refresh"/> <a id="editLink" href="editor.html?documentName=test">edit</a> <a id="versionsLink" href="">versions</a><br/>
</div>
<hr/>
<div id="documentContent"></div>
</body>
</html>