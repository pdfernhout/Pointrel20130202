<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Pointrel Chat</title>
    <script type="text/javascript" src="../../pointrel-app/libs/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="../../pointrel-app/libs/mustache.js"></script>
    <script type="text/javascript" src="../../pointrel-app/libs/sha256.js"></script>
    <script type="text/javascript" src="../../pointrel-app/js/utils_common.js"></script>
    <script type="text/javascript" src="../../pointrel-app/libs/jstorage.js"></script>
    <script type="text/javascript" src="../../pointrel-app/js/pointrel_authentication.js"></script>
    <script type="text/javascript" src="../../pointrel-app/js/pointrel20130202ForJQuery.js"></script>
    <script type="text/javascript" src="../../pointrel-app/js/pointrel_utility_classes.js"></script>
</head>
<body>
<b>Chat program</b> <a href="../../pointrel-app/bootstrap/login.html">login/logout page</a>  <span id="form_loginStatus">Not logged in</span><br/>
<!--suppress HtmlFormInputWithoutLabel -->

<input type="text" id="message_to_send" size="63"/>
<input type="button" id="button_send" onClick="send();" value="Send"/>
<input type="button" id="button_refresh" onClick="refresh();" value="Refresh"/>
<input type="checkbox" id="checkbox_auto_refresh"/>auto-refresh
<!-- <input type="button" id="button_forwards" onClick="addTestData();" value="Add Test Data" /> -->

<div id="div_messages">(Chat messages will go here on refresh)</div>
<a href="new-editor.html?documentName=bootstrap/chat-indexed.html">Edit this page</a>

<script type="text/javascript">
    $(pointrel_authentication.loginPageLoaded);
    $(setupTimer);

    var archiveURL = "../../pointrel-app/server/";
    var credentials = pointrel_authentication.getUserIDOrAnonymous();
    var archiver = new PointrelArchiver(Pointrel, archiveURL, credentials);

    function setupTimer() {
        window.setInterval(autorefresh, 5000);
    }

    var variable = new PointrelVariable(archiver, "chat-test-001");
    var messages = [];

    function autorefresh() {
        if ($("#checkbox_auto_refresh").is(':checked')) {
            refresh();
        }
    }
    
    function refresh() {
        variable.getNewVersions(newVersionsDone);
    }
    
    function newVersionsDone(error, versions, endingStatus, follower) {
        console.log("newVersionsDone: ", endingStatus, error, versions);
        if (error) { alert("error"); return; }
        if (versions) {
            var versionsReversed = versions.slice(0).reverse();
            for (var i in versionsReversed) {
                //noinspection JSUnfilteredForInLoop
                var version = versionsReversed[i];
                // messages.push(version.timestamp + " " + version.message);
                messages.push(version);
            }
            updateMessagesList();
        }
    }

    function updateMessagesList() {
        // Put all the messages int to the component that displays them
        var output = "";
        var messagesReversed = messages.slice(0);
        messagesReversed.reverse();
        for (var i in messagesReversed) {
            //noinspection JSUnfilteredForInLoop
            var oldMessage = messagesReversed[i];
            output = output + displayStringForTimestamp(oldMessage.timestamp) + " " + oldMessage.userID + " " + oldMessage.message + "<br/>";
        }
        $("#div_messages").html(output);
    }

    function send() {
        const $message_to_send = $("#message_to_send");
        var message = $message_to_send.val();
        console.log("send pressed", message);
        $message_to_send.val("");
        store(message);
    }
    
    function store(message) {
        console.log("store message", message);
        // Do a refresh or something first to make sure the variable is as up-to-date as possible
        variable.getLatestVariableVersionURI(function (error, latestVariableVersionURI) {
            console.log("in callback after tried to get latest variable");
            // TODO: Better handling for creating a variable
            if (error) { alert("Error updating variable -- ignoring in case it is new"); }
            var timestamp = new Date().toISOString();
            var userID = pointrel_authentication.getUserIDOrAnonymous();
            var version = {timestamp: timestamp, userID: userID, previousVersion: latestVariableVersionURI, message: message};
            console.log("version:", version);
            var versionAsString = JSON.stringify(version);
            console.log("versionAsString:", versionAsString);
            var newVersionURI = archiver.resource_add(encodeAsUTF8(versionAsString), "Version.json", function(error, status) {
                if (error) { alert("could not write new version: " + JSON.stringify(status)); return }
                console.log("wrote newVersionURI:", newVersionURI);
                console.log("about to update variable");
                variable.setNewVersionURI(newVersionURI, function() {
                    if (error) {
                        alert("error updating variable");
                        return;
                    }
                    refresh();
                });
            });
        });
    }


    // jQuery Document
    $(document).ready(function () {
        // Hookup enter key to send message if pressed in message_to_send field
        $("#message_to_send").keyup(function(event){
            if(event.keyCode == 13) {
                $("#button_send").click();
            }
        });
    });
</script>
</body>
</html>