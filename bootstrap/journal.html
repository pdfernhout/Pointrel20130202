<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset='utf-8'>
    <title>Pointrel journal functionality test</title>
    <script type="text/javascript" src="../libs/jquery-1.9.1.min.js"></script>

    <script type="text/javascript" src="../libs/sha256.js"></script>
    <script type="text/javascript" src="../js/utils_common.js"></script>
    <script type="text/javascript" src="../libs/jstorage.js"></script>
    <script type="text/javascript" src="../js/pointrel_authentication.js"></script>
    <script type="text/javascript" src="../js/pointrel20130202ForJQuery.js"></script>
    <script type="text/javascript" src="../js/pointrel_utility_classes.js"></script>

    <script type="text/javascript">
        var archiveURL = "../server/";
        var credentials = pointrel_authentication.getUserIDOrAnonymous();
        var archiver = new PointrelArchiver(Pointrel, archiveURL, credentials);

        var currentVersionURI = "";
        var variableName = "editor-test";

        $(document).ready(loadLatestFromParameter);
        $(pointrel_authentication.loginPageLoaded);

        function loadLatestFromParameter() {
            var chosenVariable = getParameter("documentName");
            if (chosenVariable) {
                console.log("Read document from: " + chosenVariable);
                variableName = chosenVariable;
                $("#variableName").val(chosenVariable);
                latest("ignoreMissing");
            }
            updateURI();
        }

        function updateURI() {
            var editorAppBaseURL = "editor.html";
            var viewerAppBaseURL = "viewer.html";
            var versionsAppBaseURL = "versions.html";
            var queryPart = "?documentName=" + encodeURI(variableName);
            $("a#editorLink").prop("href", editorAppBaseURL + queryPart);
            $("a#viewerLink").prop("href", viewerAppBaseURL + queryPart);
            $("a#versionsLink").prop("href", versionsAppBaseURL + queryPart);
        }

        function latest(ignoreMissing) {
            variableName = $("#variableName").val();
            updateURI();
            archiver.variable_get(variableName, function (error, variableGetResult) {
                console.log("in callback from variable_get");
                if (error) {
                    currentVersionURI = "";
                    $("#timestamp").val("");
                    $("#userID").val("");
                    $("#versionURI").val("");
                    // $("#textURI").val("");
                    $("#editor").val("");
                    var errorMessage = "Error happened on variable get; variable name may be new? Result: " + variableGetResult.message;
                    console.log(errorMessage);
                    if (!ignoreMissing) alert(errorMessage);
                    return;
                }
                var versionURI = variableGetResult.currentValue;
                archiver.resource_get(versionURI, function (error, versionContents) {
                    console.log("in callback from resource_get");
                    if (error) {
                        alert("Error happened on versionContents get");
                        return;
                    }
                    console.log("versionContents:", versionContents);
                    var version = JSON.parse(versionContents);
                    var textURI = version.value;
                    archiver.resource_get(textURI, function (error, text) {
                        console.log("in callback from resource_get");
                        if (error) {
                            alert("Error happened when getting text of version");
                            return;
                        }
                        console.log("latest updating before:", versionURI);
                        $("#timestamp").val(version.timestamp);
                        $("#userID").val(version.userID);
                        $("#versionURI").val(versionURI);
                        $("#textURI").val(textURI);
                        $("#editor").val(text);
                        console.log("latest updating after:", versionURI);
                        currentVersionURI = versionURI;
                    });
                });
            });
        }

        function appendButtonPressed() {
            progress("starting to save");
            var journalName = $("#journalName").val();
            var newContent = $("#newContent").val();
            
            console.log("newContent", newContent.length, newContent);
            var newContentAsUTF8 = encodeAsUTF8(newContent);
            console.log("newContenttAsUTF8", newContentAsUTF8.length, newContentAsUTF8);
            
            archiver.journal_put(journalName, newContentAsUTF8, function (error, response) {
                if (error) {
                    alert("Error when fetching:" + JSON.stringify(response));
                    return;
                }
                alert("Appended new content to journal: " + newContentAsUTF8);
            });
        }
        
        //////////
        
        function existsButtonPressed() {
            var journalName = $("#journalName").val();
            archiver.journal_exists(journalName, function (error, response) {
                if (error) {
                    alert("Error when fetching:" + JSON.stringify(response));
                    return;
                }
                $("#exists").val(response.exists);
            });
        }
        
        function createButtonPressed() {
            var journalName = $("#journalName").val();
            archiver.journal_create(journalName, function (error, response) {
                if (error) {
                    alert("Error when fetching:" + JSON.stringify(response));
                    return;
                }
                $("#info").val(response.result);
                alert("Created journal: " + journalName);
            });
        }
        
        var lastInfo = "";
        var lastSize = 0;
        
        function deleteButtonPressed() {
        	console.log("lastInfo: " + lastInfo);
        	console.log("lastSize: " + lastSize);
            var journalName = $("#journalName").val();
            archiver.journal_delete(journalName, lastInfo, lastSize, function (error, response) {
                if (error) {
                    alert("Error when fetching:" + JSON.stringify(response));
                    return;
                }
                $("#info").val(response.result);
                alert("Deleted journal: " + journalName);
            });
        }
        
        function infoButtonPressed() {
            var journalName = $("#journalName").val();
            archiver.journal_info(journalName, function (error, response) {
                if (error) {
                    alert("Error when fetching:" + JSON.stringify(response));
                    return;
                }
                $("#header").val(response.result.header);
                $("#size").val(response.result.size);
                lastInfo = response.result.header;
                lastSize = response.result.size;
            });
        }

        /////////////

        var progressState = "";

        function progress(state) {
            if (state) {
                if (!progressState) $("#progress").fadeIn();
                $("#progress").text(state);
            } else {
                $("#progress").fadeOut();
            }
            progessState = state;
        }
    </script>
</head>
<body>
<b>Pointrel journal support test</b><br/>
<form accept-charset="UTF-8">
    <label for="journalName">Journal: </label><input type="text" id="journalName" style="width:300px;" value="journal-test"/>
    <input type="button" onclick="latestButtonPressed()" value="Latest"/>
    <input type="button" onclick="createButtonPressed()" value="Create"/>
    <input type="button" onclick="deleteButtonPressed()" value="Delete"/><br/>
    <label for="exists">Exists: </label><input type="text" id="exists" style="width:50px;" readonly/><input type="button" onclick="existsButtonPressed()" value="Exists"/><br/>
    <label for="header">Header: </label><input type="text" id="header" style="width:600px;" readonly/><label for="size">Size: </label><input type="text" id="size" style="width:50px;" readonly/><input type="button" onclick="infoButtonPressed()" value="Info"/><br/>
    <label for="currentContent">Current content:<br/></label><textarea id="currentContent" style="width:800px; height:500px; overflow: auto;" readonly></textarea><br/>
    <label for="newContent">New content:<br/></label><textarea id="newContent" style="width:800px; height:50px; overflow: auto;"></textarea><br/>
    <a href="login.html">login/logout page</a>  <span id="form_loginStatus">Not logged in</span>  <input type="button" onclick="appendButtonPressed()" value="Append to journal"/> <span id="progress"></span> <br/>
</form>

<b>Help</b>
This tests Pointrel functionality for appending to a journal.
Add some later versions by typing text in the newContent box at the bottom and then clicking "Append to journal".
Click the "Latest" button to get the latest version of a journal document for some journal name.
To add a new journal, change the journal name then click Create.
Click Delete to delete a journal (after having previously loaded current infoButtonPressed());
Exists says whether the journal exists.
Info provides header infoButtonPressed() for the journal.
JavaScript must be enabled for this page for this test to work.
<br/><br/>
</body>
</html>