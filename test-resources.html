<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8'>
    <title>Pointrel In JavaScript test-resources</title>
    <!-- <script src="js/dojo_1.8.3_base_compressed.js"></script> -->
    <script src="js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="js/sha256.js"></script>
    <script type="text/javascript" src="js/jstorage.js"></script>
    <script type="text/javascript" src="js/pointrel_authentication.js"></script>
    <script type="text/javascript" src="js/pointrel20130202ForJQuery.js"></script>
</head>

<body>
<h3>Test resources</h3>
This automatically tests Pointrel functionality for storing and retrieving a resource string from a web server using
JavaScript.
JavaScript must be enabled for this page for this test to work.
Click here to test the back-end script with no data:
<a href="server/resource-add.php">test upload</a>.
<p></p>
ERROR
<div id="errorcontainer"></div>
<BR>
QUERY
<div id="query"></div>
<BR>
RESPONSE
<div id="response"></div>
<BR>
RETRIEVE
<div id="retrieve"></div>
<BR>

<script type="text/javascript">
    //require(["dojo/domReady!"], function(){
    //    beginTest();
    //});
    $(beginTest);

    // TODO: A no-op for now...
    function EncodeAsUTF8(text) {
        return text;
    }


    const originalDataString = "this is a test";
    const resourceURIShouldBe = "pointrel://sha256_2e99758548972a8e8822ad47fa1017ff72f06f3ff6a016851f45c398732bc50c_14.txt";

    function beginTest() {

        console.log("originalDataString", originalDataString.length, originalDataString);
        var dataStringAsUTF8 = encodeAsUTF8(originalDataString);
        console.log("dataStringAsUTF8", dataStringAsUTF8.length, dataStringAsUTF8);

        var hash = CryptoJS.SHA256(dataStringAsUTF8);
        var expectedURI = "pointrel://sha256_" + hash + "_" + dataStringAsUTF8.length + ".txt";
        console.log("Expected name: " + expectedURI);

        if (expectedURI != resourceURIShouldBe) {
            alert("expectedURI is not as it should be");
            return;
        }

        var calculatedURI = pointrel_resource_add(dataStringAsUTF8, "txt", function(error, status) {
            document.getElementById("response").innerHTML = status;
            if (error) {
                console.log("could not write resource: " + JSON.stringify(status) + " error: " + error);
                document.getElementById("errorcontainer").innerHTML = JSON.stringify(status);

            } else {
                console.log("wrote", calculatedURI);
            }
            retrieveTest(calculatedURI);
        });

        console.log("Calculated URI: ", calculatedURI);

        if (calculatedURI != resourceURIShouldBe) {
            alert("calculatedURI is not as it should be");
        }

        // alert("sent request: " + JSON.stringify(request));
        document.getElementById("query").innerHTML = "Waiting... on adding: " + calculatedURI;
    }

    function retrieveTest(textURI) {
        pointrel_resource_get(textURI, function (error, text) {
            document.getElementById("response").innerHTML = error;
            if (error) {
                alert("Error when fetching: " + JSON.stringify(text));
                return;
            }
            document.getElementById("retrieve").innerHTML = text;
        });

        document.getElementById("query").innerHTML = "Waiting... on getting: " + textURI;
    }

</script>

</body>
</html>